$(document).ready(function() {

  var tagArray = [];

  $("#toolsDialog").dialog({autoOpen : false, modal : true, show : "blind", hide : "blind", width: 600,
  height: 500});

  // This get executed when the dialog opens
  $("#toolSelectLink").click(function() {

    $(".tag_checkbox").removeAttr('checked');
    $("#showAllTools").attr('checked', true);
    $('#tool_version_selector').html("");
    $("#searchToolSelectionBox").val("");
    $('#toolSelectTable tr').show();
    $("#toolsDialog").dialog( "open");

    return false;
  });

  // This get executed when the clear selection link is clicked
  $("#clearTags").click(function() {

    $(".tag_checkbox").attr("checked",false);
    tagArray = [];

    $('#toolSelectTable tr').show();
    $("#showAllTools").attr('checked', true);

    $('#tool_version_selector').html("");
    $("#searchToolSelectionBox").val("")

    return false;
  });

  // Handles the search box; is called after each key stroke
  $("#searchToolSelectionBox").keyup(function(){
    applyTagsAndSearch();
  });

  // This function is called when the all tools checkbox changes state
  $("#showAllTools").change(function() {

    $(".tag_checkbox").not( "#showAllTools" ).attr("checked",false);
    tagArray = [];

    if ($(this).is(":checked")){
      $('#toolSelectTable tr').show();
    }else{
      $('#toolSelectTable tr').hide();
    }

  });

  // This function is called when a tag checkbox changes state
  $(".tag_checkbox:not(#showAllTools)").change(function() {

    var selectedCheckBox = $(this);

    if (selectedCheckBox.is(":checked")){

      $("#showAllTools").attr('checked', false);
      tagArray.push(selectedCheckBox.attr('name'));

    }else{

      var index = tagArray.indexOf(selectedCheckBox.attr('name'));
      if (index > -1) tagArray.splice(index, 1);

    }

    applyTagsAndSearch();

  });

  // This function applys the tags and search word that are currently in the tools table
  function applyTagsAndSearch(){

    var arrayLength = tagArray.length,
        searchBox   = $("#searchToolSelectionBox");

    $('#tool_version_selector').html("");

    if(searchBox.val().length == 0){ //If there search box is empty

      // If there are no tags
      if (arrayLength == 0){
        $('#toolSelectTable tr').show();
        $("#showAllTools").attr('checked', true);
        return;
      }

      applyTags(arrayLength);

    }else{ //If there search box is not empty

      var startsWith = new RegExp("^" + searchBox.val(), "i");

      // If there are no tags
      if (arrayLength == 0){

        $('#toolSelectTable tr').show();
        $('#toolSelectTable tr').filter(function() {
          if(startsWith.test($(this).find('.toolsLink').text()) == false) $(this).hide();
        });

        return;
      }

      applyTags(arrayLength);

      $('#toolSelectTable tr:visible').filter(function() {
        if(startsWith.test($(this).find('.toolsLink').text()) == false) $(this).hide();
      });
    }
  }

  // This function applys the tags that are currently selected in the table
  function applyTags(arrayLength){

    $('#toolSelectTable tr').hide();
    $('#toolSelectTable tr').filter(function() {
      for (var i = 0; i < arrayLength; i++) {
        if($(this).data(tagArray[i].toLowerCase()) !== undefined) $(this).show();
      }
    });
  }

  // This is executed when a tool link is clicked
  // It performs an ajax request to the server to get the tool versions currently available
  $('.toolsLink').click(function(e) {

    var userfile_checkboxes = $("input[name='file_ids[]']"),
        persistent          = parseInt($('.psel-count').text()) > 0,
        buttonLabel         = (persistent || userfile_checkboxes.is(':checked')) ? "Launch " : "Prepare ";


    // passing the button label is much cleaner this way then writing a bunch of jquery to
    // find and change the button after it comes back with the wr label. Also going forward if
    // the structure of the returned html data changes, the jquery may need to change...
    $.ajax({
      type: "GET",
      url: "/tools/tool_config_select?button_label=" + buttonLabel,
      data : "tool_id=" + $(this).data("toolId"),
      dataType: "html",
      success: function (data) {
        $("#tool_version_selector").html(data)
      }
    });

    $("#tool_version_selector").appendTo("#tool_" + $(this).data("toolId"));
    return false;
  });

  $("#tool_version_selector").delegate("#showAdditionalToolInfo", 'click', function (e) {
    $(".additionalToolInfo").show();
    return false;
  });


});





