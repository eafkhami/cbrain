$(document).ready(function() {

  var tagArray = [];

  $("#toolDialog").dialog({autoOpen : false, modal : true, show : "blind", hide : "blind", width: 600,
    height: 500});

  // This get executed when the dialog opens
  $("#toolSelectLink").click(function() {

    $(".tag_checkbox").removeAttr('checked');
    $("#AllTools").attr('checked', true);
    $('#tool_version_selector').html("");
    $("#searchToolSelectionBox").val("");
    $('#toolSelectTable tr').show();
    $("#toolSelectDialog").dialog( "open");
    return false;

  });

  // This get executed when the dialog opens
  $("#clearTags").click(function() {
  	$(".tag_checkbox").attr("checked",false);
    tagArray = [];

    $('#toolSelectTable tr').show();
    $("#AllTools").attr('checked', true);

    $('#tool_version_selector').html("");
    $("#searchToolSelectionBox").val("")

    return false;
  });


  $("#searchToolSelectionBox").keyup(function(){

    if($(this).val().length == 1){
    	$(".tag_checkbox").attr("checked",false);
      tagArray = [];
      $("#AllTools").attr('checked', false);
    }else if($(this).val().length == 0){
      $("#AllTools").attr('checked', true);
      $('#tool_version_selector').html("");
    }

    var startsWith = new RegExp("^" + $(this).val(), "i");

    $('#toolSelectTable tr').hide();
  	$('#toolSelectTable tr').filter(function() {
      return startsWith.test($(this).find('.toolsLink').text());
  	}).show();

  });


	$(".tag_checkbox").change(function() {

		if ($(this).is(":checked")){

      if(this.id == "AllTools"){ // If show all tools checkbox is clicked

        // Uncheck all other tags, set tag array to empty and show all tools
        $(".tag_checkbox").not( "#AllTools" ).attr("checked",false);
        tagArray = [];
        $('#toolSelectTable tr').show();
        return;

      }else{ // If any other checkbox is checked turn all tools checkbox off

        $("#AllTools").attr('checked', false);

      }

      tagArray.push($(this).attr('name'));

		}else{
			var index = tagArray.indexOf($(this).attr('name'));
			if (index > -1) {
			    tagArray.splice(index, 1);
			}

		}

  	var stringToEval = "";
  	var arrayLength = tagArray.length;

    if (arrayLength == 0){
      $('#toolSelectTable tr').show();
      $("#AllTools").attr('checked', true);
      return;
    }

  	for (var i = 0; i < arrayLength; i++) {
  		if (i+1 == arrayLength){
  		    stringToEval = stringToEval + "$(this).data(\"" + tagArray[i].toLowerCase() + "\") !== undefined";
  		}else{
  			stringToEval = stringToEval + "$(this).data(\"" + tagArray[i].toLowerCase() + "\") !== undefined || ";
  		}
  	}

    $('#toolSelectTable tr').hide();

  	$('#toolSelectTable tr').filter(function() {
  	    return eval(stringToEval);
  	}).show();


	});


});


$(document).delegate('.toolsLink', 'click', function(e) {

  var userfile_checkboxes = $("input[name='file_ids[]']"),
      persistent          = parseInt($('.psel-count').text()) > 0,
      buttonLabel = (persistent || userfile_checkboxes.is(':checked')) ? "Launch " : "Prepare ";


  $.ajax({
       type: "GET",
       url: "/tools/tool_config_select?button_label=" + buttonLabel,
       data : "tool_id=" + $(this).data("toolId"),
       dataType: "html",
       success: function (data) {
         $("#tool_version_selector").html(data)
       }
  });

	$("#tool_version_selector").appendTo("#tool" + $(this).data("toolId"));
  return false;

});


