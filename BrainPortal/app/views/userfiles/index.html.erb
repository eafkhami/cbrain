
<%-
#
# CBRAIN Project
#
# Copyright (C) 2008-2012
# The Royal Institution for the Advancement of Learning
# McGill University
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#
-%>

<% title("Files") %>

<!-- **************************************************************************** -->
<!-- CELL #1 : The two menu button lines, the pagination, and the userfiles table -->
<!-- **************************************************************************** -->

<% content_for :scripts do %>
  <%= javascript_tag (render :partial => "launch_task.js.erb",    :formats => [:js]).to_s %>
  <%= javascript_tag (render :partial => "file_selection.js.erb", :formats => [:js]).to_s %>
<% end %>

<div id="userfiles_menus_and_filelist">

  <%= multi_form_tag(:method => :post, "data-type"  => "script") do %>

      <div class="index_block">
        <%= render :partial => "userfiles/file_menu" %>

        <div id="userfiles_display">
          <%= render :partial => 'userfiles_display' %>
        </div>

        <%  sync_statuses = [ "InSync", "ProvNewer", "CacheNewer", "Corrupted", "ToCache", "ToProvider" ] %>
        <%= center_legend("Synchronization symbols:", sync_statuses.map { |s| [ status_html_symbol(s), s ] } ) %>
      </div>
  <% end %> <!-- form -->
</div> <!-- cell #1 -->



  <nav id="context-menu" class="context-menu">
    <ul class="context-menu__items">

        <li class="context-menu__item">

  		  <a href="#" id="move" class="context-menu__link">Move</a>
  		  <div id="dialogMove" title="Move">
     		  <%= multi_form_tag(:method => :post, "data-type"  => "script") do %>

  	         <% writable_dps = DataProvider.find_all_accessible_by_user(current_user).all.select { |dp| ! dp.read_only? } %>
  	         To Data Provider:
  	         <%= data_provider_select(:data_provider_id_for_mv_cp, { :data_providers => writable_dps }, :include_blank => "(Select Destination)") %><br/>
  	         <!-- jQuery has a bug for the following checkbox, which explains the style attribute. -->
  	         Overwrite files on Destination:
  	         <input type="checkbox" name="crush_destination" value="crush" style="position: relative; left: 0;"><br/>
  	         <%= hijacker_submit_button("Move Files", :name => :move, :url  => url_for(:action  => :change_provider), :class => "button", :method  => :post) %>


 	        <div id="userfiles_display_move" style="display:none"></div>
  			 <% end %>

  		  </div>

        </li>

      <li class="context-menu__item">
      <a href="#" id="delete" class="context-menu__link" > Delete</a>
	  <div id="dialogDel" title="Delete">
		  <%= multi_form_tag(:method => :post, "data-type"  => "script") do %>
        		For any type:
        		<%= hijacker_submit_button("Delete", :url     => url_for(:action  => :delete_files),
                                             :confirm => "Are you sure you want to delete the selected files?",
                                             :class     => "button",
                                             :method  => :delete)
       									  %>
	       		<div id="userfiles_display_delete" style="display:none"></div>
			<% end %> <!-- form -->

	  </div>
      </li>

      <li class="context-menu__item">
      <a href="#" id="copy" class="context-menu__link" > Copy</a>
	  <div id="dialogCopy" title="Copy">
		  <%= multi_form_tag(:method => :post, "data-type"  => "script") do %>
     	         <% writable_dps = DataProvider.find_all_accessible_by_user(current_user).all.select { |dp| ! dp.read_only? } %>
     	         To Data Provider:
     	         <%= data_provider_select(:data_provider_id_for_mv_cp, { :data_providers => writable_dps }, :include_blank => "(Select Destination)") %><br/>
     	         <!-- jQuery has a bug for the following checkbox, which explains the style attribute. -->
     	         Overwrite files on Destination:
     	         <input type="checkbox" name="crush_destination" value="crush" style="position: relative; left: 0;"><br/>
     	         <%= hijacker_submit_button("Copy Files", :name => :copy, :url  => url_for(:action  => :change_provider), :class => "button", :method  => :post) %>
	       		<div id="userfiles_display_copy" style="display:none"></div>
			<% end %> <!-- form -->
	  </div>
      </li>

      <li class="context-menu__item">
      <a href="#" id="download" class="context-menu__link" > Download</a>
	  <div id="dialogDownload" title="Download">
		  <%= multi_form_tag(:method => :post, "data-type"  => "script") do %>
		        Specify Download File Name (optional):
		        <%= text_field_tag :specified_filename %>
		        <%= hijacker_submit_button("Download Files", :url  => url_for(:controller => 'userfiles', :action => 'download'), :ajax_submit  => false, :class => "button", :method  => :get) %>
	       		<div id="userfiles_display_download" style="display:none"></div>
			<% end %> <!-- form -->
	  </div>
      </li>

      <li class="context-menu__item">
      <a href="#" id="collection" class="context-menu__link" > Create Collection</a>
	  <div id="dialogCollection" title="Collection">
		  <%= multi_form_tag(:method => :post, "data-type"  => "script") do %>
         <% writable_dps = DataProvider.find_all_accessible_by_user(current_user).all.select { |dp| ! dp.read_only? } %>

		        Name for the collection (optional):
		        <%= text_field_tag :collection_name %>
		        To Data Provider:
		        <%= data_provider_select(:data_provider_id_for_collection, { :data_providers => writable_dps }, :include_blank => "(Select Destination)") %>
		        <%= hijacker_submit_button("Create Collection", :url    => url_for(:action  => :create_collection),
		                                                        :class  => "button",
		                                                        :method => :post)
		        %>
	       		<div id="userfiles_display_collection" style="display:none"></div>
			<% end %> <!-- form -->
	  </div>
      </li>

      <li class="context-menu__item">
      <a href="#" id="compress" class="context-menu__link" > Compress</a>
	  <div id="dialogCompress" title="Compress">
		  <%= multi_form_tag(:method => :post, "data-type"  => "script") do %>
		        For file(s):
		        <%= hijacker_submit_button("Compress",  :url     => url_for(:action  => :compress ),
		                                                    :confirm => "Are you sure you want to compress or uncompress the selected files?",
		                                                    :class   => "button",
		                                                    :method  => :post)
		        %>
	       		<div id="userfiles_display_compress" style="display:none"></div>
			<% end %> <!-- form -->
	  </div>
      </li>

      <li class="context-menu__item">
      <a href="#" id="uncompress" class="context-menu__link" > Uncompress</a>
	  <div id="dialogUncompress" title="Uncompress">
		  <%= multi_form_tag(:method => :post, "data-type"  => "script") do %>
		        For file(s):
		        <%= hijacker_submit_button("Uncompress",  :url     => url_for(:action  => :compress ),
		                                                    :confirm => "Are you sure you want to compress or uncompress the selected files?",
		                                                    :class   => "button",
		                                                    :method  => :post)
		        %>
	       		<div id="userfiles_display_uncompress" style="display:none"></div>
			<% end %> <!-- form -->
	  </div>
      </li>

      <li class="context-menu__item">
      <a href="#" id="archive" class="context-menu__link" > Archive</a>
	  <div id="dialogArchive" title="Archive">
		  <%= multi_form_tag(:method => :post, "data-type"  => "script") do %>
		  For collection(s) and archive(s):
		        <%= hijacker_submit_button("Archive",   :url     => url_for(:action  => :archive_management ),
		                                                    :confirm => "Are you sure you want to archive or unarchive the selected files collection?",
		                                                    :class   => "button",
		                                                    :method  => :post)
		        %>
	       		<div id="userfiles_display_archive" style="display:none"></div>
			<% end %> <!-- form -->
	  </div>
      </li>

      <li class="context-menu__item">
      <a href="#" id="unarchive" class="context-menu__link" > Unarchive</a>
	  <div id="dialogUnarchive" title="Unarchive">
		  <%= multi_form_tag(:method => :post, "data-type"  => "script") do %>
		  For collection(s) and archive(s):
		        <%= hijacker_submit_button("Unarchive",   :url     => url_for(:action  => :archive_management ),
		                                                    :confirm => "Are you sure you want to archive or unarchive the selected files collection?",
		                                                    :class   => "button",
		                                                    :method  => :post)
		        %>
	       		<div id="userfiles_display_unarchive" style="display:none"></div>
			<% end %> <!-- form -->
	  </div>
      </li>


    </ul>


  </nav>




<script type="text/javascript">
   /*
  $( ".dt-table" ).click(function() {


  });*/



  $( ".dt-table input[type='checkbox']" ).click(function() {
	  if($(this).prop('checked')){
		 $("#menulinks").show();
	  }else{
	  	$("#menulinks").hide();
	  }
  });



 $(document).ready(function() {

	 $( ".button" ).click(function() {
	  $("#dialogMove").dialog('close');
	  $("#dialogDel").dialog('close');
	  $("#dialogCopy").dialog('close');
	  $("#dialogDownload").dialog('close');
	  $("#dialogCollection").dialog('close');
	  $("#dialogCompress").dialog('close');
	  $("#dialogUncompress").dialog('close');
	  $("#dialogArchive").dialog('close');
	  $("#dialogUnarchive").dialog('close');
	 });

     $("#dialogMove, #dialogDel, #dialogCopy, #dialogDownload, #dialogCollection, #dialogCompress, #dialogArchive, #dialogUnarchive, #dialogUncompress").dialog({autoOpen : false, modal : true, show : "blind", hide : "blind"});

     // next add the onclick handler
     $("#move").click(function() {

       $("#dialogMove").dialog( "open");
	   toggleMenuOff();
       return false;
     });

     // next add the onclick handler
     $("#delete").click(function() {
       $("#dialogDel").dialog("open");
	   toggleMenuOff();
       return false;
     });

     $("#archive").click(function() {
       $("#dialogArchive").dialog("open");
	   toggleMenuOff();
       return false;
     });

     $("#unarchive").click(function() {
       $("#dialogUnarchive").dialog("open");
	   toggleMenuOff();
       return false;
     });

     $("#compress").click(function() {
       $("#dialogCompress").dialog("open");
	   toggleMenuOff();
       return false;
     });

     $("#uncompress").click(function() {
       $("#dialogUncompress").dialog("open");
	   toggleMenuOff();
       return false;
     });

     $("#collection").click(function() {
       $("#dialogCollection").dialog("open");
	   toggleMenuOff();
       return false;
     });

     $("#download").click(function() {
       $("#dialogDownload").dialog("open");
	   toggleMenuOff();
       return false;
     });

     $("#copy").click(function() {
       $("#dialogCopy").dialog("open");
	   toggleMenuOff();
       return false;
     });


 });

 (function() {

   "use strict";

   //////////////////////////////////////////////////////////////////////////////
   //////////////////////////////////////////////////////////////////////////////
   //
   // H E L P E R    F U N C T I O N S
   //
   //////////////////////////////////////////////////////////////////////////////
   //////////////////////////////////////////////////////////////////////////////

   /**
    * Function to check if we clicked inside an element with a particular class
    * name.
    *
    * @param {Object} e The event
    * @param {String} className The class name to check against
    * @return {Boolean}
    */
   function clickInsideElement( e, className ) {
     var el = e.srcElement || e.target;

     if ( el.classList.contains(className) ) {
       return el;
     } else {
       while ( el = el.parentNode ) {
         if ( el.classList && el.classList.contains(className) ) {
           return el;
         }
       }
     }

     return false;
   }

   /**
    * Get's exact position of event.
    *
    * @param {Object} e The event passed in
    * @return {Object} Returns the x and y position
    */
   function getPosition(e) {
     var posx = 0;
     var posy = 0;

     if (!e) var e = window.event;

     if (e.pageX || e.pageY) {
       posx = e.pageX;
       posy = e.pageY;
     } else if (e.clientX || e.clientY) {
       posx = e.clientX + document.body.scrollLeft + document.documentElement.scrollLeft;
       posy = e.clientY + document.body.scrollTop + document.documentElement.scrollTop;
     }

     return {
       x: posx,
       y: posy
     }
   }

   //////////////////////////////////////////////////////////////////////////////
   //////////////////////////////////////////////////////////////////////////////
   //
   // C O R E    F U N C T I O N S
   //
   //////////////////////////////////////////////////////////////////////////////
   //////////////////////////////////////////////////////////////////////////////

   /**
    * Variables.
    */
   var contextMenuClassName = "context-menu";
   var contextMenuItemClassName = "context-menu__item";
   var contextMenuLinkClassName = "context-menu__link";
   var contextMenuActive = "context-menu--active";

   var taskItemClassName = "dt-sel-row";
   var taskItemInContext;

   var clickCoords;
   var clickCoordsX;
   var clickCoordsY;

   var menu = document.querySelector("#context-menu");
   var menuItems = menu.querySelectorAll(".context-menu__item");
   var menuState = 0;
   var menuWidth;
   var menuHeight;
   var menuPosition;
   var menuPositionX;
   var menuPositionY;

   var windowWidth;
   var windowHeight;

   /**
    * Initialise our application's code.
    */
   function init() {
     contextListener();
     clickListener();
     keyupListener();
     resizeListener();
   }

   /**
    * Listens for contextmenu events.
    */
   function contextListener() {
     document.addEventListener( "contextmenu", function(e) {
       taskItemInContext = clickInsideElement( e, taskItemClassName );

       if ( taskItemInContext ) {
         e.preventDefault();
         toggleMenuOn();
         positionMenu(e);
		 	$( "#userfiles_display" ).clone().appendTo("#userfiles_display_move");
		 	$( "#userfiles_display" ).clone().appendTo("#userfiles_display_delete");
		 	$( "#userfiles_display" ).clone().appendTo("#userfiles_display_copy");
		 	$( "#userfiles_display" ).clone().appendTo("#userfiles_display_download");
		 	$( "#userfiles_display" ).clone().appendTo("#userfiles_display_collection");
		 	$( "#userfiles_display" ).clone().appendTo("#userfiles_display_compress");
		 	$( "#userfiles_display" ).clone().appendTo("#userfiles_display_uncompress");
		 	$( "#userfiles_display" ).clone().appendTo("#userfiles_display_archive");
		 	$( "#userfiles_display" ).clone().appendTo("#userfiles_display_unarchive");

       } else {
         taskItemInContext = null;
         toggleMenuOff();
       }
     });
   }

   /**
    * Listens for click events.
    */
   function clickListener() {
     document.addEventListener( "click", function(e) {
       var clickeElIsLink = clickInsideElement( e, contextMenuLinkClassName );

       if ( clickeElIsLink ) {
         e.preventDefault();
         menuItemListener( clickeElIsLink );
       } else {
         var button = e.which || e.button;
         if ( button === 1 ) {
           toggleMenuOff();
         }
       }
     });
   }

   /**
    * Listens for keyup events.
    */
   function keyupListener() {
     window.onkeyup = function(e) {
       if ( e.keyCode === 27 ) {
         toggleMenuOff();
       }
     }
   }

   /**
    * Window resize event listener
    */
   function resizeListener() {
     window.onresize = function(e) {
       toggleMenuOff();
     };
   }

   /**
    * Turns the custom context menu on.
    */
   function toggleMenuOn() {
     if ( menuState !== 1 ) {
       menuState = 1;
       menu.classList.add( contextMenuActive );
     }
   }

   /**
    * Turns the custom context menu off.
    */
   function toggleMenuOff() {
     if ( menuState !== 0 ) {
       menuState = 0;
       menu.classList.remove( contextMenuActive );
     }
   }

   /**
    * Positions the menu properly.
    *
    * @param {Object} e The event
    */
   function positionMenu(e) {
     clickCoords = getPosition(e);
     clickCoordsX = clickCoords.x;
     clickCoordsY = clickCoords.y;

     menuWidth = menu.offsetWidth + 4;
     menuHeight = menu.offsetHeight + 4;

     windowWidth = window.innerWidth;
     windowHeight = window.innerHeight;

     if ( (windowWidth - clickCoordsX) < menuWidth ) {
       menu.style.left = windowWidth - menuWidth + "px";
     } else {
       menu.style.left = clickCoordsX + "px";
     }

     if ( (windowHeight - clickCoordsY) < menuHeight ) {
       menu.style.top = windowHeight - menuHeight + "px";
     } else {
       menu.style.top = clickCoordsY + "px";
     }
   }

   /**
    * Dummy action function that logs an action when a menu item link is clicked
    *
    * @param {HTMLElement} link The link that was clicked
    */
   function menuItemListener( link ) {
     //alert( "Task ID - " + taskItemInContext.getAttribute("data-id") + ", Task action - " + link.getAttribute("data-action"));
     toggleMenuOff();
   }

   /**
    * Run the app.
    */
   init();

 })();



   </script>

 <style type="text/css">

 *,
 *::before,
 *::after {
   box-sizing: border-box;
 }


 .container {
   margin: 0 auto;
   padding: 0 24px;
   max-width: 960px;
 }

 /* primary header */

 .primary-header {
   padding: 24px 0;
   text-align: center;
   border-bottom: solid 2px #cfcfcf;
 }

 .primary-header__title {
   color: #393939;
   font-size: 36px;
 }

 .primary-header__title small {
   font-size: 18px;
   color: #898989;
 }

 /* content */

 .content {
   padding: 48px 0;
   border-bottom: solid 2px #cfcfcf;
 }

 .content__footer {
   margin-top: 12px;
   text-align: center;
 }

 /* footer */

 .primary-footer {
   padding: 24px 0;
   color: #898989;
   font-size: 14px;
   text-align: center;
 }

 /* tasks */

 .tasks {
   list-style: none;
   margin: 0;
   padding: 0;
 }

 .task {
   display: flex;
   justify-content: space-between;
   padding: 12px 0;
   border-bottom: solid 1px #dfdfdf;
 }

 .task:last-child {
   border-bottom: none;
 }

 /* context menu */

 .context-menu {
   display: none;
   position: absolute;
   z-index: 10;
   padding: 12px 0;
   width: 240px;
   background-color: #fff;
   border: solid 1px #dfdfdf;
   box-shadow: 1px 1px 2px #cfcfcf;
 }

 .context-menu--active {
   display: block;
 }

 .context-menu__items {
   list-style: none;
   margin: 0;
   padding: 0;
 }

 .context-menu__item {
   display: block;
   margin-bottom: 4px;
 }

 .context-menu__item:last-child {
   margin-bottom: 0;
 }

 .context-menu__link {
   display: block;
   padding: 4px 12px;
   color: #0066aa;
   text-decoration: none;
 }

 .context-menu__link:hover {
   color: #fff;
   background-color: #0066aa;
 }





 #menulinks ul
 {
 margin: 0;
 padding: 0;
 list-style-type: none;
 }

 #menulinks ul li { display: inline; }


 </style>

